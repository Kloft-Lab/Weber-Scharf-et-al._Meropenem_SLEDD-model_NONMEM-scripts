$SIZES      PD=-400
$PROBLEM PK Base model MERO SLED   1-CMT MERO SLED ADVAN 13 - allometrically scaled   PK Base model MERO SLED   1-CMT MERO SLED ADVAN 13 - allometrically scaled
$INPUT      ID TIME AMT RATE DV EVID DIALID AGE DIUR CLCR
            CRRT KREA ALB HEIGHT WEIGHT SEX
            BLOFLOW DIALFLOW ULTRFIL BLOVOL MDV OCC CRCLCG
            TALD TIMEONSLED MEANDD INFTYPE CKDEPI TIMECALC	TIMEREP	BLOFLOWCALC1	BLOFLOWCALC2	BLOFLOWCALC3	BLOFLOWCALC4

$DATA      SLEDDATA_20221017_OCC.csv IGNORE=#
$SUBROUTINE ADVAN13 TOL=9
;----------------------------------
$MODEL      COMP (CENT,DEFOBS,DEFDOS)
;----------------------------------

$PK
IF (OCC.EQ.0) THEN
IOVCL_SLED=0
ENDIF
IF (OCC.EQ.1) THEN
IOVCL_SLED=ETA(3)
ENDIF
IF (OCC.EQ.2) THEN
IOVCL_SLED=ETA(4)
ENDIF
IF (OCC.EQ.3) THEN
IOVCL_SLED=ETA(5)
ENDIF
IF (OCC.EQ.4) THEN
IOVCL_SLED=ETA(6)
ENDIF
IF (OCC.EQ.5) THEN
IOVCL_SLED=ETA(7)
ENDIF
;;; CL_RESCLCR-DEFINITION START
CL_RESCLCR = ( 1 + THETA(6)*(CLCR - 4.13))
;;; CL_RESCLCR-DEFINITION END
;;; CL_RES-RELATION START
CL_RESCOV=CL_RESCLCR
;;; CL_RES-RELATION END
;---------------------------------- 
  IF (DIALID.EQ.1) THEN 
  TVCL_SLED = THETA(5)
  CL_SLED = TVCL_SLED * EXP(IOVCL_SLED) ; assuming log-normal distribution of individual PK parameters and normal distribution of IOV
  ELSE 
  TVCL_SLED = 0  
  CL_SLED = TVCL_SLED
  ENDIF

  TVCL_RES = THETA(1) 
  TVCL_RES = CL_RESCOV*TVCL_RES
  CL_RES = TVCL_RES *((WEIGHT/70)**0.75) * EXP(ETA(1)) ; assuming log-normal distribution of individual PK parameters and normal distribution of IIV
  CL = CL_SLED + CL_RES  
  TVV = THETA(2)
  V = TVV *(WEIGHT/70) * EXP(ETA(2))   
  K10 = CL/V
  KA = RATE
  S1 = V

;----------------------------------
$DES
 DADT(1)= - K10 * A(1)
;----------------------------------
$THETA  
 (0,2.99534,10) ;CL_REN
 (0,36.756,100) ;V
  0 FIX ;additive error
 (0,0.391525,5) ;proportional error
 (0,2.63404,20) ;CL_SLED
$THETA  (-0.012,0.0268148,0.242) ;CL_REN_CLCR
$OMEGA  
0.04862  ;IIV_CL_REN
 0  FIX  ;IIV_V

$OMEGA BLOCK (1) 0.1 ;IOV CL_SLED_OCC1
$OMEGA BLOCK (1) SAME ;IOV CL_SLED_OCC2
$OMEGA BLOCK (1) SAME ;IOV CL_SLED_OCC3
$OMEGA BLOCK (1) SAME ;IOV CL_SLED_OCC4
$OMEGA BLOCK (1) SAME ;IOV CL_SLED_OCC5
;----------------------------------
$SIGMA  
1  FIX  ;     EPS(1)
;----------------------------------
$ERROR
;----------------------------------

 MERO= A(1)/S1
 IPRED=MERO
 W=SQRT(THETA(3)**2+(THETA(4)*IPRED)**2)
 DEL=0
 IRES=DV-IPRED
 IWRES=IRES/W
 Y=IPRED + W* EPS(1)


IF(IPRED.EQ.0) DEL=0.0001

;----------------------------------

$ESTIMATION METHOD=1 INTERACTION MAXEVAL=9999 SIG=2 PRINT=5 NOABORT
;----------------------------------
MCETA=1
$COVARIANCE PRINT=E
;----------------------------------

$TABLE ID TIME TALD DIALID OCC CL_RES CL_SLED ETA1 ETA2 ETA3 ETA4 ETA5 ETA6 ETA7 CLCR MEANDD CL DV MDV EVID PRED IPRED RES TIMECALC	TIMEREP	BLOFLOWCALC1	BLOFLOWCALC2	BLOFLOWCALC3	BLOFLOWCALC4
 IRES WRES KREA ALB HEIGHT WEIGHT SEX BLOFLOW DIALFLOW ULTRFIL BLOVOL CRCLCG TALD TIMEONSLED IWRES CWRES NOAPPEND ONEHEADER NOPRINT FILE=sdtab29
; Xpose
$TABLE ID TIME TALD CL_RES CL_SLED DV MDV EVID PRED IPRED RES CWRES IRES WRES IWRES CL V ETA1 ETA2 ETA3 ETA4 ETA5 ETA6 ETA7 DIALID TIMECALC	TIMEREP	BLOFLOWCALC1	BLOFLOWCALC2	BLOFLOWCALC3	BLOFLOWCALC4
 AGE DIUR CLCR CRRT KREA ALB HEIGHT WEIGHT SEX BLOFLOW DIALFLOW ULTRFIL BLOVOL CRCLCG TALD TIMEONSLED MEANDD INFTYPE CKDEPI FIRSTONLY ONEHEADER NOPRINT FILE=patab29
